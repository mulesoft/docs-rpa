= Mail Session (Outlook with OAuth)

The _Mail Session (Outlook with OAuth)_ enables you to establish a connection to a mail server using MS Outlook and then use mail operations as reading mail (*Read Mail*), sending mail (*Send Mail*), and changing e-mails (*Set Mail*), by using the corresponding Action Steps

== Before you Begin

You need to have an Azure account to create an application for Outlook.

[[properties]]
== Properties

* *OAuth Authentication* Settings
** *OAuth Host*
+
The host address that is used to get the credentials. The default address for Outlook services is https://login.microsoftonline.com/common/oauth2/v2.0/ . This address might change if the customer uses a self hosted service.
** *Client ID*
+
In order to authenticate with the OAuth Host, an Azure application has to be defined in the customers space. This Azure application has an id, that is unique in the entire OAuth Host space and allows a user to explicitly grant or revoke access for this Azure application to his account. For more information how to create this Azure application for Outlook, see here: https:// learn.microsoft.com/en-us/azure/active-directory/develop/quickstart-register-app
** *Client Secret*
+
This secret allows Design Studio to prove to the OAuth Host, that it has received the permission to access user accounts on behalf of the registered Azure application. Without it the authentication is not possible.
** *Redirect Uri*
+
This is the URI to which the OAuth Host will redirect, after the user has completed the authentication attempt. This redirect URI has to be registered with the Azure application. Only if the entered redirect URI matches one of the registered URI, the OAuth Host will allow the authentication.
** *Scopes*
+
The scopes define, which permission the user grants to the Azure application. By default, we request the following permissions:

*** *offline_access*
+
(*Required*) Enables access via a refresh token, which you can use to repeatedly log in to the mail services without requiring user interaction each time.
*** *https://outlook.office.com/IMAP.AccessAsUser.All*
+
(*Required* when using IMAP) Enables reading and moving emails from the Outlook IMAP server.
*** *https://outlook.office.com/POP.AccessAsUser.All*
+
(*Required* when using POP3) Enables reading emails from the Outlook POP3 server.
*** *https://outlook.office.com/SMTP.Send*
+
(*Required* when using SMTP) Enables sending emails from the Outlook SMTP server.
*** *openid email*
+
Enables RPA Builder to automatically detect the email account used to log in to the Azure application. If this scope is omitted, you must provide an email in the wizard.
+
** *Email address*
+
The email address fills automatically if RPA Builder can detected it from the authentication attempt. If the *openid email* scope is omitted, you must provide an email address manually.

* *Incoming Mail Operation* Settings
** *Protocol used*
+
(Mail Protocol) Displays the communication protocol to use: IMAP, Exchange, or POP3.
**  *Encryption used*
+
(Encryption) Displays the encryption protocol to use: None, SSL/TLS, or STARTTLS.
** *Server address*
+
(String) The server address that is entered in the wizard.
** *Server Port*
+
(Integer, Default: `143`) The selected port.

* *Outgoing Mail Operation* Setting
**  *Encryption used*
+
(Encryption) Displays the encryption protocol to use: None, SSL/TLS, or STARTTLS.
** *SMTP Server address*
+
(String) The URL of the selected SMTP mail server.
** *SMTP Server Port*
+
(Integer) Displays the selected port.
** *Send test mail to*
+
(String) E-mail address to which the test mail is to
be sent.

== Inbound Variables

* *Incoming Mail*
* *Server address*
+
(String) The server address that is entered in the wizard.
* *Server port*
+
(Integer) Displays the selected port.
* *User account*
+
Login data that you require to log in to the server.
* *Outgoing Mail*
* *SMTP Server address*
+
(String) Here, you see the URL of the selected SMTP mail server.
* *SMTP User account*
+
Login data that you require to log in to the SMTP
server.
* *Use Different Credentials*
+
(Boolean) Select this option to set
different credentials to those specified under Incoming Mail - User
account for outgoing mail.

== Outbound Variables

The _Mail Session_ Action Step has no outbound variables.

== Wizard

image:mail-session-outlook-oauth-wizard.png[The Mail Session (Outlook with OAuth) Action Step Wizard, 60%, 60%]

The wizard contains the following sections: *Operation Mode*, *OAuth Authentication*, *Incoming Mail*, and *Outgoing Mail*.

=== Operation Mode

In *Operation Mode* you determine what happens and which area activates in the Mail Session. The
following modes are available:

* *Read and send mails*
+
Enables you to configure the Incoming and Outgoing
Mail areas so you can read and send mails.
* *Read mails from inbox*
+
Enables editing for the Incoming Mail section, so that you can only read mails.
* *Send mails via SMTP*
+
Enables editing for the Outgoing Mail section , so that you can only send mails.
+
Note that if you selected the _Send mails via SMTP_ mode, you can't use the Read mail Action Step in the Mail Session.
This is also true if you have selected the _Read mails from inbox_ mode. In this case, you can't use the Send Mail Action Step.

=== OAuth Authentication

The *OAuth Authentication* section enables you to create a set of tokens, that don't rely on a user’s password to authenticate with the email server. After you create the refresh token, you can use it to repeatedly log in to the services without asking the user's password again.

Follow these steps to authenticate with your credentials:

. Complete the *OAuth Authentication* configuration by specifying the required properties.
+
Refer to <<properties, OAuth Authentication Settings>> for a description of each property.
. Click *Authenticate*.
+
This step starts the authentication process with the OAuth Host, which opens the login page in your default browser.
. In the OAuth Host’s login page, complete the login process.
. Close the browser.

After completing the last step, the wizard shows that you are authenticated:
image:email-outlook-authentication.png[The Logged in confirmation message in the authentication settings window, 50%, 50%]

==== Generating a OAuth Refresh Token

Instead of authenticating via the *Mail Session (Outlook with OAuth) wizard*, you can pin the refresh token if you obtain it externally. In this case, you still need to fill (or pin) the rest of the fields.

To generate a and configure a refresh token:

. In the *Tools* menu, select *Generate OAuth Refresh Token*.
+
image:generate-oauth-token.png[The Generate OAuth Refresh Token options in the Tools menu, 40%, 40%]
. Complete the *OAuth Token Creator* form that appears.
+
image:generate-token-form.png[The OAuth Token Creator Form, 60%, 60%]
+
If you already configured a Mail Session (Outlook with OAuth), the data automatically fills with the last data you entered in the wizard.
. Click *Authenticate*.
. Click *Copy Token to Clipboard*.
. Paste the token in an alphanumeric Server Based Variable.
. Pin the variable to the field *Refresh Token* in the *Mail Session (Outlook with OAuth)* wizard.
+
You can also pin the other values from the *OAuth Token Creator*.
+
By using a Server Based Variable you don’t need to upload a new version of your Workflow to RPA Manager if your token expires or your user gets logged out of Microsoft. In such case, regenerate the refresh token for the same user with the *OAuth Token Creator* and update the assigned Server Based Variable on RPA Manager.

=== Incoming Mail

In the *Incoming Mail* area, you can configure all the settings necessary to
import e-mails from an e-mail server. Here, you can also find the *Test Connection Button*, which you can use to test whether the connection to
the mail server can be established.

=== Outgoing Mail

The *Outgoing Mail* area opens if you select the checkbox *Send mails*. If
you wish to send e-mails, enter the SMTP mail server settings here.

Using the *Send test mail* button, you can check the connection to the
SMTP server and send a test mail. Enter the e-mail address under *Send
test mail to*.

== See Also

* xref:toolbox-mail-operations-read-mail.adoc[Read Mail]
* xref:toolbox-mail-operations-send-mail.adoc[Send Mail]
* xref:toolbox-mail-operations-set-mail.adoc[Set Mail]
* https://azure.microsoft.com/en-us/[Azure^]
* https://learn.microsoft.com/en-us/exchange/client-developer/exchange-web-services/how-to-authenticate-an-ews-application-by-using-oauth[Authenticate an EWS application by using OAuth^]
* https://learn.microsoft.com/en-us/exchange/client-developer/legacy-protocols/how-to-authenticate-an-imap-pop-smtp-application-by-using-oauth[Authenticate an IMAP, POP or SMTP connection using OAuth^]
